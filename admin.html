<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Leo Flora åå°ç®¡ç†</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/contentful-management/10.0.0/contentful-management.browser.min.js"></script>
    
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; background: #f4f4f4; }
        .box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #2c3e50; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; font-size: 14px; color:#555;}
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; }
        .file-box { border: 2px dashed #ccc; padding: 25px; text-align: center; margin-top: 20px; border-radius: 8px; cursor: pointer; background:#fafafa;}
        .file-box:hover { background: #f0f0f0; border-color: #666; }
        button { width: 100%; background: #2c3e50; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; margin-top: 25px; cursor: pointer; font-weight:bold; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #log { margin-top: 20px; font-size: 13px; max-height: 250px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; display: none; }
        .success { color: #27ae60; font-weight:bold; }
        .error { color: #e74c3c; font-weight:bold; }
    </style>
</head>
<body>

<div class="box">
    <h2>ğŸ¦ Leo Flora äº§å“ä¸Šä¼ åå° (V5.0)</h2>
    
    <div id="status-tip" style="margin-bottom:15px; font-size:12px; color:#666;">
        ç¯å¢ƒæ£€æµ‹ï¼š<span id="env-status">â³ åˆå§‹åŒ–ä¸­...</span>
    </div>
    
    <label>1. Contentful Space ID (ç©ºé—´ID)</label>
    <input type="text" id="spaceId" placeholder="ä¾‹å¦‚ï¼šk8s7d..." value="">
    
    <label>2. Management Token (ç®¡ç†ä»¤ç‰Œ)</label>
    <input type="password" id="mgmtToken" placeholder="CFPAT-xxxxxxxx..." value="">

    <div class="file-box" onclick="document.getElementById('fileInput').click()">
        <span id="fileName">ğŸ“‚ ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶ (.xlsx)</span>
        <input type="file" id="fileInput" accept=".xlsx" style="display:none" onchange="handleFile(this)">
    </div>

    <button id="startBtn" onclick="startUpload()" disabled>ç­‰å¾…é€‰æ‹©æ–‡ä»¶...</button>
    <div id="log"></div>
</div>

<script>
    let excelData = [];

    window.onload = function() {
        const tip = document.getElementById('env-status');
        if (typeof contentfulManagement !== 'undefined') {
            tip.innerHTML = "âœ… ç³»ç»Ÿæ­£å¸¸ (å·²åŠ è½½ Vercel æ‰˜ç®¡èµ„æº)";
            tip.style.color = "green";
        } else {
            tip.innerHTML = "âŒ ä¾ç„¶å¤±è´¥ã€‚è¯·ç¡®è®¤ sdk.js å·²ä¸Šä¼ åˆ° GitHub ä¸”æ–‡ä»¶åæ­£ç¡®ã€‚";
            tip.style.color = "red";
        }
    };

    function handleFile(input) {
        const file = input.files[0];
        if(!file) return;
        document.getElementById('fileName').innerText = "âœ… å·²å°±ç»ª: " + file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            if(typeof XLSX === 'undefined') {
                 alert("Excel è§£æåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                 return;
            }
            const workbook = XLSX.read(data, {type: 'array'});
            excelData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const btn = document.getElementById('startBtn');
            btn.innerText = `å¼€å§‹ä¸Šä¼  (${excelData.length} ä¸ªäº§å“)`;
            btn.style.background = "#27ae60";
            btn.disabled = false;
        };
        reader.readAsArrayBuffer(file);
    }

    function log(msg, type='') {
        const logDiv = document.getElementById('log');
        logDiv.style.display = 'block';
        logDiv.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function startUpload() {
        const spaceId = document.getElementById('spaceId').value.trim();
        const token = document.getElementById('mgmtToken').value.trim();

        if(!spaceId || !token) return alert("è¯·å¡«å†™ Space ID å’Œ Token");

        const btn = document.getElementById('startBtn');
        btn.disabled = true;
        btn.innerText = "â³ è¿æ¥ä¸­...";
        log("æ­£åœ¨è¿æ¥ Contentful...", "info");

        try {
            const client = contentfulManagement.createClient({ accessToken: token });
            const space = await client.getSpace(spaceId);
            const env = await space.getEnvironment('master');

            log("âœ… è¿æ¥æˆåŠŸï¼å¼€å§‹ä¸Šä¼ ...", "success");

            for (let i = 0; i < excelData.length; i++) {
                const item = excelData[i];
                const sku = item.sku ? String(item.sku) : 'No-SKU';
                const name = item.name || 'æœªå‘½å';
                
                try {
                    const entry = await env.createEntry('product', {
                        fields: {
                            sku: { 'en-US': sku },
                            name: { 'en-US': name },
                            desc: { 'en-US': item.desc || '' }
                        }
                    });
                    await entry.publish();
                    log(`ğŸ‰ [${i+1}/${excelData.length}] ${name} å‘å¸ƒæˆåŠŸï¼`, "success");
                } catch (err) {
                    log(`âŒ ${name} å¤±è´¥: ${err.message}`, "error");
                }
                await new Promise(r => setTimeout(r, 200));
            }
            btn.innerText = "å…¨éƒ¨å®Œæˆ";
            alert("ä¸Šä¼ å®Œæˆï¼");
        } catch (err) {
            log(`ğŸ’¥ é”™è¯¯: ${err.message}`, "error");
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
